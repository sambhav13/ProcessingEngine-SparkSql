<?xml version="1.0" encoding="UTF-8"?>
<Algorithm ID='7' Name='Internation Reprocess'>

	<!-- <SubAlgorithm ID='13' Name='International Reprocess'> -->
	<SubAlgorithm ID='13' Name='International Reprocess'
		LoopDef="1">
		<Step ID='3' Name='SubAlgorithm-International ReprocessNGNtest' ProcedureCall='bspSubAlgorithm' 
		StepOrder='50' IsLoop='true' IsIXBill='true' IsParallel='false' PreviousStepID='-1'>
			<SubStep type="sqlCall" orderID="1" SubAlgorithmID='19'
				ParamNumber='4'>
				<Procedure>bspSubAlgorithm</Procedure>
				<Param>SubAlgorithmID</Param>
				<Param>ProcessLogID</Param>
				<Param>LoopOn</Param>
				<Param>LoopOnValue</Param>
			</SubStep>
		</Step>
		<Step ID='7' Name='Resolve Trunk' ProcedureCall='exec bspCDRTrunkResolve_NGN'
			StepOrder='30' IsLoop='true' IsIXBill='true' IsParallel='false'
			PreviousStepID='-1'>
			<SubStep type="sqlQuery" orderID="1" virtualSwitch="Yes">
				SELECT
				InSwitchID, InTrunkName,
				InternalOutTrunkName,
				InternalInTrunkName,
				OutTrunkName, OutSwitch,
				CallingNumber,
				OriginalCalledNumber,
				CalledNumber, CallType,
				CallDate, CallHour,
				CallMinute, CallSecond,
				CallDuration,
				CircuitDuration, Answered,
				Seized, FaultCode, RingBusy,
				UserBusy,
				TerminalReject, SeqNum,
				RegistryID, BERID,
				OutSwitchID,
				PartitionID, CallTypeID,
				CDRDirectionID,
				InAgreementID, InAccountID,
				InNumberPlanID,
				InDestinationID,
				InCountryID, InCallCharID,
				InServiceID, InProductID,
				InServiceLevelID, InRouteClassID,
				OutAgreementID,
				OutAccountID, OutNumberPlanID,
				OutDestinationID,
				OutCountryID,
				OutCallCharID, OutServiceID,
				OutProductID,
				OutServiceLevelID,
				OutRouteClassID,
				RoutingDestinationID,
				RoutingCalendarID,
				RoutingDateTimeBandID,
				RoutingProductID,
				RoutingServiceID,
				RoutingCallCharID,
				InEventCaseID,
				InCaseRatingMethodID,
				OutEventCaseID, OutCaseRatingMethodID,
				CaseRatingMethodID,
				CDRTariffTypeCombinationID, UsedForVSR,
				InBoundClosed,
				OutBoundClosed, InAccountingTreatment,
				OutAccountingTreatment, NPRN,
				CustomField1, CustomField2,
				CustomField3, InRefDestinationID,
				NetworkCode,
				Portability_PreresolvedFlag, PortedFlag, OriginID,
				PortedFromID,
				PortedToID, PortedDestinationID, InJitter, OutJitter,
				InPacketDelay,
				OutPacketDelay, InPacketLoss, OutPacketLoss, InMOS,
				OutMOS,
				InternalCodec, InExternalCodec, OutExternalCodec,
				InternalCodecNumber, InExternalCodecNumber, OutExternalCodecNumber,
				CustomField4, CustomField5, CustomField6, CustomField7,
				CustomField8,
				CustomField9, CustomField10, CustomField11,
				CustomField12,
				tmpCalledNumber1, tmpCalledNumber2, tmpCalledNumber3,
				tmpCalledNumber4, tmpCalledNumber5, tmpCalledNumber6,
				tmpCalledNumber7, tmpCalledNumber8, tmpCalledNumber9,
				tmpCalledNumber10, tmpCalledNumber11, tmpCalledNumber12,
				tmpCalledNumber13, tmpCalledNumber14, tmpCalledNumber15,
				tmpCalledNumber16, tmpCalledNumber17, tmpCalledNumber18,
				tmpOtherNumber1, tmpOtherNumber2, tmpOtherNumber3, tmpOtherNumber4,
				tmpOtherNumber5, tmpOtherNumber6, tmpOtherNumber7, tmpOtherNumber8,
				tmpOtherNumber9, tmpOtherNumber10, tmpOtherNumber11,
				tmpOtherNumber12, tmpOtherNumber13, tmpOtherNumber14,
				tmpOtherNumber15, tmpOtherNumber16, tmpOtherNumber17,
				tmpOtherNumber18, InSettlementDate, OutSettlementDate,
				InSettlementDateTime, OutSettlementDateTime,
				InSettlementTimeZoneShift, OutSettlementTimeZoneShift, InUNPID,
				InAccountingNumberPlanID, InAccountingDestinationID,
				InAccountingEventCaseID, InContractID, InisOperationalFTR,
				InisAccountingFTR, InisMissingFTR, OutUNPID,
				OutAccountingNumberPlanID, OutAccountingDestinationID,
				OutAccountingEventCaseID, OutContractID, OutisOperationalFTR,
				OutisAccountingFTR, OutisMissingFTR, InAccountingContractID,
				OutAccountingContractID, InAccountingCallCharID,
				OutAccountingCallCharID, InAccountingServiceID,
				OutAccountingServiceID, InAccountingProductID,
				OutAccountingProductID, RoutingDestinationTypeID,
				InProvisionalStatementID, OutProvisionalStatementID, CustomField13,
				CustomField14, CustomField15, CustomField16, CustomField17,
				CustomField18, CustomField19, CustomField20, CustomField21,
				CustomField22, CustomField23, CustomField24, CustomField25,
				CustomField26, CustomField27, CustomField28, CustomFieldD1,
				CustomFieldD2, CustomFieldD3, MDD, MNPDestinationID, MNPDialCode,
				ProcessInbound, NPANXXDialCode, UnRoundedCallDuration,
				InAccountingCountryID, OutAccountingCountryID, InSettlementDD,
				OutSettlementDD, InAccountingSettlementDD,
				OutAccountingSettlementDD,
				ProcessOutbound, InCompatibility70Flag,
				OutCompatibility70Flag,
				OriginCountryID, tmpCallingNumber1,
				tmpCallingNumber2,
				tmpCallingNumber3, tmpCallingNumber4,
				tmpCallingNumber5,
				tmpCallingNumber6, tmpCallingNumber7,
				tmpCallingNumber8,
				tmpCallingNumber9, tmpCallingNumber10,
				tmpCallingNumber11,
				tmpCallingNumber12, tmpCallingNumber13,
				tmpCallingNumber14,
				tmpCallingNumber15, tmpCallingNumber16,
				tmpCallingNumber17,
				tmpCallingNumber18, InGPDestinationID1,
				InGPDestinationID2,
				InGPDestinationID3, InGPDestinationID4,
				OutGPDestinationID1,
				OutGPDestinationID2, OutGPDestinationID3,
				OutGPDestinationID4,
				InGPContractID1, InGPContractID2,
				InGPContractID3, InGPContractID4,
				OutGPContractID1, OutGPContractID2,
				OutGPContractID3,
				OutGPContractID4, InIsOriginBasedRating,
				OutIsOriginBasedRating,
				trunkresolveVS(InTrunkName,InSwitchID,'inbound',0) As InTrunkID,
				trunkresolveVS(InTrunkName,InSwitchID,'inbound',1) As
				InCommercialTrunkID,
				trunkresolveVS(OutTrunkName,OutSwitchID,'outbound',0) As OutTrunkID,
				trunkresolveVS(OutTrunkName,OutSwitchID,'outbound',1) As
				OutCommercialTrunkID
				From wtbECRTempBefTrunk
			</SubStep>
			<SubStep type="sqlQuery" orderID="1" virtualSwitch="No">
				SELECT InSwitchID, InTrunkName,
				InternalOutTrunkName,
				InternalInTrunkName,
				OutTrunkName, OutSwitch,
				CallingNumber,
				OriginalCalledNumber,
				CalledNumber, CallType,
				CallDate, CallHour,
				CallMinute, CallSecond,
				CallDuration,
				CircuitDuration, Answered,
				Seized, FaultCode, RingBusy,
				UserBusy,
				TerminalReject, SeqNum,
				RegistryID, BERID,
				OutSwitchID,
				PartitionID, CallTypeID,
				CDRDirectionID,
				InAgreementID, InAccountID,
				InNumberPlanID,
				InDestinationID,
				InCountryID, InCallCharID,
				InServiceID, InProductID,
				InServiceLevelID, InRouteClassID,
				OutAgreementID,
				OutAccountID, OutNumberPlanID,
				OutDestinationID,
				OutCountryID,
				OutCallCharID, OutServiceID,
				OutProductID,
				OutServiceLevelID,
				OutRouteClassID,
				RoutingDestinationID,
				RoutingCalendarID,
				RoutingDateTimeBandID,
				RoutingProductID,
				RoutingServiceID,
				RoutingCallCharID,
				InEventCaseID,
				InCaseRatingMethodID,
				OutEventCaseID, OutCaseRatingMethodID,
				CaseRatingMethodID,
				CDRTariffTypeCombinationID, UsedForVSR,
				InBoundClosed,
				OutBoundClosed, InAccountingTreatment,
				OutAccountingTreatment, NPRN,
				CustomField1, CustomField2,
				CustomField3, InRefDestinationID,
				NetworkCode,
				Portability_PreresolvedFlag, PortedFlag, OriginID,
				PortedFromID,
				PortedToID, PortedDestinationID, InJitter, OutJitter,
				InPacketDelay,
				OutPacketDelay, InPacketLoss, OutPacketLoss, InMOS,
				OutMOS,
				InternalCodec, InExternalCodec, OutExternalCodec,
				InternalCodecNumber, InExternalCodecNumber, OutExternalCodecNumber,
				CustomField4, CustomField5, CustomField6, CustomField7,
				CustomField8,
				CustomField9, CustomField10, CustomField11,
				CustomField12,
				tmpCalledNumber1, tmpCalledNumber2, tmpCalledNumber3,
				tmpCalledNumber4, tmpCalledNumber5, tmpCalledNumber6,
				tmpCalledNumber7, tmpCalledNumber8, tmpCalledNumber9,
				tmpCalledNumber10, tmpCalledNumber11, tmpCalledNumber12,
				tmpCalledNumber13, tmpCalledNumber14, tmpCalledNumber15,
				tmpCalledNumber16, tmpCalledNumber17, tmpCalledNumber18,
				tmpOtherNumber1, tmpOtherNumber2, tmpOtherNumber3, tmpOtherNumber4,
				tmpOtherNumber5, tmpOtherNumber6, tmpOtherNumber7, tmpOtherNumber8,
				tmpOtherNumber9, tmpOtherNumber10, tmpOtherNumber11,
				tmpOtherNumber12, tmpOtherNumber13, tmpOtherNumber14,
				tmpOtherNumber15, tmpOtherNumber16, tmpOtherNumber17,
				tmpOtherNumber18, InSettlementDate, OutSettlementDate,
				InSettlementDateTime, OutSettlementDateTime,
				InSettlementTimeZoneShift, OutSettlementTimeZoneShift, InUNPID,
				InAccountingNumberPlanID, InAccountingDestinationID,
				InAccountingEventCaseID, InContractID, InisOperationalFTR,
				InisAccountingFTR, InisMissingFTR, OutUNPID,
				OutAccountingNumberPlanID, OutAccountingDestinationID,
				OutAccountingEventCaseID, OutContractID, OutisOperationalFTR,
				OutisAccountingFTR, OutisMissingFTR, InAccountingContractID,
				OutAccountingContractID, InAccountingCallCharID,
				OutAccountingCallCharID, InAccountingServiceID,
				OutAccountingServiceID, InAccountingProductID,
				OutAccountingProductID, RoutingDestinationTypeID,
				InProvisionalStatementID, OutProvisionalStatementID, CustomField13,
				CustomField14, CustomField15, CustomField16, CustomField17,
				CustomField18, CustomField19, CustomField20, CustomField21,
				CustomField22, CustomField23, CustomField24, CustomField25,
				CustomField26, CustomField27, CustomField28, CustomFieldD1,
				CustomFieldD2, CustomFieldD3, MDD, MNPDestinationID, MNPDialCode,
				ProcessInbound, NPANXXDialCode, UnRoundedCallDuration,
				InAccountingCountryID, OutAccountingCountryID, InSettlementDD,
				OutSettlementDD, InAccountingSettlementDD,
				OutAccountingSettlementDD,
				ProcessOutbound, InCompatibility70Flag,
				OutCompatibility70Flag,
				OriginCountryID, tmpCallingNumber1,
				tmpCallingNumber2,
				tmpCallingNumber3, tmpCallingNumber4,
				tmpCallingNumber5,
				tmpCallingNumber6, tmpCallingNumber7,
				tmpCallingNumber8,
				tmpCallingNumber9, tmpCallingNumber10,
				tmpCallingNumber11,
				tmpCallingNumber12, tmpCallingNumber13,
				tmpCallingNumber14,
				tmpCallingNumber15, tmpCallingNumber16,
				tmpCallingNumber17,
				tmpCallingNumber18, InGPDestinationID1,
				InGPDestinationID2,
				InGPDestinationID3, InGPDestinationID4,
				OutGPDestinationID1,
				OutGPDestinationID2, OutGPDestinationID3,
				OutGPDestinationID4,
				InGPContractID1, InGPContractID2,
				InGPContractID3, InGPContractID4,
				OutGPContractID1, OutGPContractID2,
				OutGPContractID3,
				OutGPContractID4, InIsOriginBasedRating,
				OutIsOriginBasedRating,
				trunkresolve(InTrunkName,InSwitchID,'inbound',0) As InTrunkID,
				trunkresolve(InTrunkName,InSwitchID,'inbound',1) As
				InCommercialTrunkID,
				trunkresolve(OutTrunkName,OutSwitchID,'outbound',0) As OutTrunkID,
				trunkresolve(OutTrunkName,OutSwitchID,'outbound',1) As
				OutCommercialTrunkID
				From wtbECRTempBefTrunk
			</SubStep>
			<SubStep type="filter" orderID="2" virtualSwitch="NA">
				InTrunkID
			</SubStep>
			<SubStep type="registerTempTable" orderID="3" virtualSwitch="NA">
				wtbECRTempAftTrunk
			</SubStep>
		</Step>
		<Step ID='34' Name='Resolve Agreement' ProcedureCall='exec bspCDRAgreementResolve_NGN'
			StepOrder='40' IsLoop='true' IsIXBill='true' IsParallel='false'
			PreviousStepID='-1'>
			<SubStep type="sqlQuery" orderID="1">
				SELECT RegistryID,
				InSwitchID, InTrunkName,
				InternalOutTrunkName, InternalInTrunkName,
				OutTrunkName, OutSwitch,
				CallingNumber,
				OriginalCalledNumber,CalledNumber, CallType,
				CallDate, CallHour,
				CallMinute, CallSecond,
				CallDuration,
				CircuitDuration, Answered,
				Seized, FaultCode, RingBusy,
				UserBusy,
				TerminalReject, SeqNum,BERID,
				OutSwitchID,
				PartitionID, CallTypeID,
				CDRDirectionID, InNumberPlanID,
				InDestinationID, InCountryID,
				InCallCharID, InServiceID, InProductID,
				InServiceLevelID, InRouteClassID, OutNumberPlanID,
				OutDestinationID,
				OutCountryID,
				OutCallCharID, OutServiceID,
				OutProductID,
				OutServiceLevelID,
				OutRouteClassID,
				RoutingDestinationID,
				RoutingCalendarID,RoutingDateTimeBandID,
				RoutingProductID,
				RoutingServiceID,
				RoutingCallCharID, InEventCaseID,
				InCaseRatingMethodID,
				OutEventCaseID, OutCaseRatingMethodID,
				CaseRatingMethodID,CDRTariffTypeCombinationID, UsedForVSR,
				InBoundClosed,
				OutBoundClosed, InAccountingTreatment,
				OutAccountingTreatment, NPRN,
				CustomField1, CustomField2,
				CustomField3, InRefDestinationID, NetworkCode,
				Portability_PreresolvedFlag, PortedFlag, OriginID,
				PortedFromID,
				PortedToID, PortedDestinationID, InJitter, OutJitter,
				InPacketDelay,
				OutPacketDelay, InPacketLoss,OutPacketLoss, InMOS, OutMOS,
				InternalCodec, InExternalCodec, OutExternalCodec,
				InternalCodecNumber, InExternalCodecNumber, OutExternalCodecNumber,
				CustomField4, CustomField5,CustomField6, CustomField7,
				CustomField8,
				CustomField9, CustomField10,
				CustomField11,
				CustomField12,
				tmpCalledNumber1, tmpCalledNumber2,
				tmpCalledNumber3,
				tmpCalledNumber4, tmpCalledNumber5,tmpCalledNumber6,
				tmpCalledNumber7, tmpCalledNumber8,
				tmpCalledNumber9,
				tmpCalledNumber10, tmpCalledNumber11,
				tmpCalledNumber12,
				tmpCalledNumber13, tmpCalledNumber14,
				tmpCalledNumber15,tmpCalledNumber16, tmpCalledNumber17,
				tmpCalledNumber18,
				tmpOtherNumber1,
				tmpOtherNumber2, tmpOtherNumber3,
				tmpOtherNumber4,
				tmpOtherNumber5,
				tmpOtherNumber6,
				tmpOtherNumber7,tmpOtherNumber8, tmpOtherNumber9, tmpOtherNumber10,
				tmpOtherNumber11,
				tmpOtherNumber12, tmpOtherNumber13,
				tmpOtherNumber14,
				tmpOtherNumber15, tmpOtherNumber16,
				tmpOtherNumber17,tmpOtherNumber18, InSettlementDate,
				OutSettlementDate,
				InSettlementDateTime, OutSettlementDateTime,
				InSettlementTimeZoneShift, OutSettlementTimeZoneShift,
				InUNPID,InAccountingNumberPlanID, InAccountingDestinationID,
				InAccountingEventCaseID, InContractID, InisOperationalFTR,
				InisAccountingFTR, InisMissingFTR,
				OutUNPID,OutAccountingNumberPlanID, OutAccountingDestinationID,
				OutAccountingEventCaseID, OutContractID, OutisOperationalFTR,
				OutisAccountingFTR, OutisMissingFTR,
				InAccountingContractID,OutAccountingContractID,
				InAccountingCallCharID,
				OutAccountingCallCharID,
				InAccountingServiceID,
				OutAccountingServiceID, InAccountingProductID,
				OutAccountingProductID,RoutingDestinationTypeID,
				InProvisionalStatementID, OutProvisionalStatementID, CustomField13,
				CustomField14, CustomField15, CustomField16, CustomField17,
				CustomField18,CustomField19, CustomField20, CustomField21,
				CustomField22, CustomField23,
				CustomField24, CustomField25,
				CustomField26, CustomField27,
				CustomField28,
				CustomFieldD1,CustomFieldD2, CustomFieldD3, MDD, MNPDestinationID,
				MNPDialCode,
				ProcessInbound,
				NPANXXDialCode, UnRoundedCallDuration,
				InAccountingCountryID,
				OutAccountingCountryID,InSettlementDD,
				OutSettlementDD, InAccountingSettlementDD,
				OutAccountingSettlementDD, ProcessOutbound, InCompatibility70Flag,
				OutCompatibility70Flag, OriginCountryID,tmpCallingNumber1,
				tmpCallingNumber2, tmpCallingNumber3, tmpCallingNumber4,
				tmpCallingNumber5, tmpCallingNumber6, tmpCallingNumber7,
				tmpCallingNumber8, tmpCallingNumber9,tmpCallingNumber10,
				tmpCallingNumber11, tmpCallingNumber12, tmpCallingNumber13,
				tmpCallingNumber14, tmpCallingNumber15, tmpCallingNumber16,
				tmpCallingNumber17, tmpCallingNumber18,InGPDestinationID1,
				InGPDestinationID2, InGPDestinationID3, InGPDestinationID4,
				OutGPDestinationID1, OutGPDestinationID2, OutGPDestinationID3,
				OutGPDestinationID4, InGPContractID1,InGPContractID2,
				InGPContractID3, InGPContractID4, OutGPContractID1,
				OutGPContractID2, OutGPContractID3, OutGPContractID4,
				InIsOriginBasedRating, OutIsOriginBasedRating,InTrunkID,
				InCommercialTrunkID, OutTrunkID,
				OutCommercialTrunkID,
				agreementresolve(InCommercialTrunkID,'inbound',0) as InAgreementID,
				agreementresolve(InCommercialTrunkID,'inbound',1) as InAccountID,
				agreementresolve(OutCommercialTrunkID,'outbound',0) as
				OutAgreementID,
				agreementresolve(OutCommercialTrunkID,'outbound',1)
				as OutAccountID
				FROM wtbECRTempAftTrunk
			</SubStep>
			<SubStep type="filter" orderID="2">
				InTrunkID
			</SubStep>
			<SubStep type="registerTempTable" orderID="3">
				wtbECRTempAftAgreement
			</SubStep>
		</Step>

		
	</SubAlgorithm>

</Algorithm>	